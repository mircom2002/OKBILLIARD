<html>
    <head>

        <style>
            body{
                /*background-image: url("/assets/grad_blackwood.jpg");
                background-repeat:no-repeat;
                background-size: 100% 200%;*/
                background-color: black;
            }

            .navbar{
                opacity:0.8;
            }

            .up_btn{
                height:90px;
                font-size:40px;
                text-align:center;
                opacity:0.8;
            }

            ._player{
                text-align:center;
                font-size:30px;
                color:white;

            }

            ._score{
                text-align:center;
                width:100%;
                background-color:white;
                height:350px;
                border-radius: 10px;
                border: 2px solid grey;
                opacity:0.9;
                font-size:200px;
            }

            ._score_text{
                text-align:center;
                width:100%;
                position:absolute;
                bottom:200px;
                height:50px;
                font-size:50px;
            }

             ._score_point{
                margin-top:5px;
                width:98%;
                background-color: white;
                border-radius:10px;
                height:140px;
                margin-left:auto;
                margin-right:auto;
                opacity:0.9;
                text-align:center;
                font-size:50px;

            }

            ._tim{
                margin-top:5px;
                background-color:#ccc;
                height:200px;
                border-radius: 10px;
                border: 2px solid grey;
                opacity:0.9;
                font-size:120px;
                text-align:center;
            }

            ._inn{
                background-color:#ccc;
                height:200px;
                border-radius: 10px;
                border: 2px solid grey;
                opacity:0.9;
                font-size:120px;
                text-align:center;
            }

            ._stop{
                margin-top:5px;
                height:90px;
                text-align:center;
                border-radius:10px;
                opacity:0.8;
                font-size:50px;
            }

            ._turn{
                width:90%;
                height:100px;
                font-size:50px;
                opacity:0.9;
                margin-left:auto;
                margin-right:auto;
            }
            ._point{
                width:200px;
                font-size:90px;
            }
            ._user{
                background-color:white;
            }
            table{
                cursor:pointer;
            }
            .ul{
                font-size:25px;
            }
            ._char_box{
                background-color:white;
                opacity:0.5;
                border:1px solid grey;
                margin:4px;
                font-size:30px;
                border-radius: 10px;
                cursor:pointer;
                text-align:center;
                padding-top:10%;
                padding-bottom:10%;
            }

            ._player_box{
                background-color:white;
                border:1px solid grey;
                margin:4px;
                font-size:30px;
                border-radius: 10px;
                padding:4px;
                opacity:0.5;
                cursor:pointer;
            }

            .leftPlayer{
                text-align:left;
            }

            .rightPlayer{
                text-align: right;
            }

            .media-object{
                height:70%;
                margin-right:20px;
                margin-left:20px;
            }

            ._hr_line{
                margin-top:2px;
                margin-bottom:10px;
            }
        </style>
    </head>

    <body>
        <%= render :partial => 'main/brandMenu' %>

        <div class="section">
            <div class="container">
                <div class="row">
                    <div class="btn-group btn-group-justified">
                      <div class="btn-group">
                        <button type="button"  onClick="_color_change();" class="btn btn-default up_btn">공색변경</button>
                      </div>
                      <div class="btn-group">
                        <button type="button" id="_sel" class="btn btn-primary dropdown-toggle  up_btn" data-toggle="dropdown">다이선택</button>
                            <ul style="opacity:0.9; width:100%; " class="dropdown-menu" role="menu">
                              <li style="height:80px; font-size:40px; text-align:center;"><a href="#">대대</a></li>
                              <li style="height:80px; font-size:40px; text-align:center;"><a href="#">중대</a></li>
                            </ul>
                      </div>
                      <div class="btn-group">
                        <button type="button" class="btn btn-danger  up_btn init_btn">초기화</button>
                      </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="_menu">
            <div class="section">
                <div class="container">
                    <div class="row">
                        <div class="col-md-6">
                            <div id='0' class="leftPlayer _player_box">
                                <div class="media">
                                  <div class="media-left media-middle">
                                      <img class="media-object" src="/assets/emptyuser.png">
                                  </div>
                                  <div class="media-body">
                                    <p class="media-heading">선공</p><hr class="_hr_line">
                                    <h5 class="media-heading">Name</h5>
                                    <h4 class="_leftName"></h4>
                                    <h5 class="media-heading">Avg.</h5>
                                    <h4 class="_leftAverage"></h4>
                                    <h5 class="media-heading">Score</h5>
                                    <h4 class="_leftScore"></h4>
                                  </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id='0' class="rightPlayer _player_box">
                                <div class="media">
                                  <div class="media-body">
                                    <p class="media-heading">후공</p><hr  class="_hr_line">
                                    <h5 class="media-heading">Name</h5>
                                    <h4 class="_rightName"></h4>
                                    <h5 class="media-heading">Avg.</h5>
                                    <h4 class="_rightAverage"></h4>
                                    <h5 class="media-heading">Score</h5>
                                    <h4 class="_rightScore"></h4>
                                  </div>
                                  <div class="media-right media-middle">
                                      <img class="media-object" src="/assets/emptyuser.png">
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <%Okdb.all.each do |t| %>
                            <div class="col-md-2">
                                <div id="<%=t.id%>" class="_char_box">
                                    <%=t.name%>
                                </div>
                            </div>
                        <% end %>
                    </div>
                </div>
            </div>
        </div>

        <div class="_board">
        <div class="container">
            <div class="row">
                <div style="padding-left:10px; padding-right:10px;"class="col-md-5">
                    <div class="_player _leftName" style="cursor:pointer;">
                        Player
                    </div>
                    <div class="_score">
                        1
                    </div>
                    <div class="_score_text">
                        Average :
                    </div>
                    <table border="1" class="_score_point">
                        <tr>
                        <td class="_pb">+1</td>
                        <td class="_pb">+3</td>
                        <td class="_pb">+5</td>
                        <td class="_point"  rowspan="2">POINT</td>
                        </tr>
                        <tr>
                        <td class="_pb">-1</td>
                        <td class="_pb">-3</td>
                        <td class="_pb">-5</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-2">
                    <div class="_player ">
                        이닝
                    </div>
                    <div style="padding-left:10px; padding-right:10px;" class="row">
                        <div class="row">
                            <div class="_inn">
                                -
                            </div>
                        </div>
                        <div class="row">
                            <div class="_tim">
                                40
<!--                                     <div class="_score_text">
                                    Time
                                </div>
-->
                            </div>
                        </div>
                        <div class="row">
                            <button type="button" class="btn btn-warning btn-block _stop">STOP</button>
                        </div>
                    </div>
                </div>
                <div style="padding-left:10px; padding-right:10px;" class="col-md-5">
                    <div class="_player  _rightName" style="cursor:pointer;">
                        Player
                    </div>
                    <div class="_score">
                        2
                    </div>
                    <div class="_score_text">
                        Average :
                    </div>
                    <table border="1" class="_score_point">
                        <tr>
                        <td class="_pb">+1</td>
                        <td class="_pb">+3</td>
                        <td class="_pb">+5</td>
                        <td class="_point" rowspan="2">POINT</td>
                        </tr>
                        <tr>
                        <td class="_pb">-1</td>
                        <td class="_pb">-3</td>
                        <td class="_pb">-5</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
        <div class="section">
            <div class="container">
                <div class="row">
                    <button type="button"  class="btn btn-success btn-block _turn">차례넘기기</button>
                </div>
            </div>
        </div>


    </body>

    <script>
        var selectChar=0;
        var gameState=0;
        var _t=40;
        var timer;
        var stop=0;
        var de_color=0;

        function _color_change(){
            if(de_color==0){
                $("._player").eq(0).css("color", "#ffff99");
                $("._score").eq(0).css("background-color", "#ffff99");
                $("._player").eq(2).css("color", "white");
                $("._score").eq(1).css("background-color", "white");

                 lid=$(".leftPlayer").attr("id");
                 if(lid==0){
                    $("._player_box").eq(0).css("background-color","#ff9");
                    $("._player_box").eq(1).css("background-color","white");
                 }else{
                    $("div[id="+lid+"]").css("background-color", "#ffff99");
                     rid=$(".rightPlayer").attr("id");
                    $("div[id="+rid+"]").css("background-color", "white");
                }
                de_color=1;

            }else{
                de_color=0;
                $("._player").eq(0).css("color", "white");
                $("._score").eq(0).css("background-color", "white");
                $("._player").eq(2).css("color", "#ffff99");
                $("._score").eq(1).css("background-color", "#ffff99");

                 lid=$(".leftPlayer").attr("id");
                 if(lid==0){
                    $("._player_box").eq(0).css("background-color","white");
                    $("._player_box").eq(1).css("background-color","#ff9");
                 }else{
                    $("div[id="+lid+"]").css("background-color", "white");
                    rid=$(".rightPlayer").attr("id");
                    $("div[id="+rid+"]").css("background-color", "#ff9");
                }
            }

        }

        function init_scoreBoard(){
            de_color=0;
            init_left_box();
            init_right_box();
            init_char_box();

            _color_change();
            selectChar=0;
            $("._turn").text("연습 게임 시작");
            $(".init_btn").text("초기화");
            $("._stop").text("-");
            $("._score").text("0");
            $("._inn").text("-");
            $("._tim").text("-");
            $("._point").text("-");
            $("._score_text").text("Average : -");
            $("._score").css("opacity", 0.4);
            $("._score_point").css("opacity", 0.4);
            $("._score_text").css("opacity", 0.4);
            $("._inn").css("opacity", 0.4);
            $("._tim").css("opacity", 0.4);
            $("._stop").css("opacity", 0.4);
            $("._player").css("opacity", 0.4);
            clearTimeout(timer);
            _t-40;
            stop=0;
            gameState=0;
        }

        $(".init_btn").on("click", function(){


            if(gameState==0){   // Before Game
                init_scoreBoard();
                return;
            }

            if(selectChar==2){  // Practice Game

                var tp=parseInt($("._point").eq((gameState+1)%2).text());
                var sp=parseInt($("._score").eq((gameState+1)%2).text());
                $("._score").eq((gameState+1)%2).text(tp+sp);

                $("._score_text").eq((gameState+1)%2).text("Average : "+(parseInt($("._score").eq((gameState+1)%2).text())/parseInt((gameState+1)/2)).toFixed(2));

                w_id=$("._player_box").eq((gameState+1)%2).attr("id");
                w_score=$("._score").eq((gameState+1)%2).text();

                inning=parseInt((gameState+1)/2);

                l_id=$("._player_box").eq((gameState)%2).attr("id");
                l_score=$("._score").eq((gameState)%2).text();

                $.ajax({
                            data: { id:w_id, score:w_score, inning:inning, lid:l_id, lscore:l_score},
                            url: "/main/updateinfo",
                            dataType:"json",
                            success: function(res){
                                //alert(res);
                             },error:function(request,status,error){
    alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);}
                        });

            }

            init_scoreBoard();
            $("._board").slideUp();
            $("._menu").slideToggle();

        });



        function gameStart(){
            $("._menu").slideToggle();
            $("._board").slideDown();
            $("._turn").text("차례 넘기기");
            $(".init_btn").text("게임 종료");
            $("._stop").text("STOP");
            $("._score").text("0");
            $("._inn").text("1");
            $("._tim").text("40");
            $("._point").text("0");
            $("._score").css("opacity", 0.9);
            $("._score_point").css("opacity", 0.9);
            $("._inn").css("opacity", 0.9);
            $("._tim").css("opacity", 0.9);
            $("._stop").css("opacity", 0.9);
            $("._player").css("opacity", 0.9);
        }

        function _timer(){
            if(stop==0) _t--;
            if(_t<0) return;
            $("._tim").text(_t);
            timer=setTimeout("_timer()", 1000);
        }

        function gameHandle(){
            if(gameState==1){

                gameStart();
            }
            _t=40;
            $("._tim").text("40");
            timer=setTimeout("_timer()", 1000);

            $("._inn").text(parseInt((gameState+1)/2));

            $("._score").eq((gameState+1)%2).css("opacity",0.9);
            $("._score_point").eq((gameState+1)%2).css("opacity",0.9);
            $("._score_text").eq((gameState+1)%2).css("opacity",0.9);
            $("._score").eq(gameState%2).css("opacity",0.2);
            $("._score_point").eq(gameState%2).css("opacity",0.2);
            $("._score_text").eq((gameState)%2).css("opacity",0.2);
        }

        $(document).ready(function(){
            init_scoreBoard();
            $("._board").slideUp(0);
        });

         // $(document).on("click", function(){
         //     $("._board").slideToggle(500);
         // });

        $("._turn").on("click", function(){

            if(selectChar==1){
                return;
            }

            if(gameState>0){

                var tp=parseInt($("._point").eq((gameState+1)%2).text());
                var sp=parseInt($("._score").eq((gameState+1)%2).text());
                $("._score").eq((gameState+1)%2).text(tp+sp);

                $("._score_text").eq((gameState+1)%2).text("Average : "+(parseInt($("._score").eq((gameState+1)%2).text())/parseInt((gameState+1)/2)).toFixed(2));
            }

            gameState++;
            stop=0;
            $("._stop").text("STOP");
            $("._point").text("0");
            clearTimeout(timer);
            gameHandle();
        });


        $("._stop").on("click", function(){
            if(stop==0 && gameState>0){
                $("._stop").text("START");
                stop=1;
            }else if(stop==1){
                $("._stop").text("STOP");
                stop=0;
            }
        });

        $( "._pb" )
          .mouseover(function() {
                $(this).css("opacity", 0.1);
            })
          .mouseout(function() {
                $(this).css("opacity", 0.8);
          })
          .mouseup(function(){
                if(gameState==0) return;
                var p=parseInt($(this).text());
                var tp=parseInt($("._point").eq((gameState+1)%2).text());
                $("._point").eq((gameState+1)%2).text(p+tp);
          });

          $("._point").on("click", function(){
                if(gameState==0) return;

                $(this).text(parseInt($(this).text())+1);
                $("._point").eq((gameState)%2).text(0);

                stop=0;
                $("._stop").text("STOP");
                clearTimeout(timer);
                _t=40;
                $("._tim").text("40");
                timer=setTimeout("_timer()", 1000);

          });

          function init_left_box(){
            $(".leftPlayer").css("opacity", "0.5");
            $(".leftPlayer").attr("id", 0);
            $("._leftName").text("Player");
            $("._leftScore").text("Score");
            $("._leftAverage").text("Average");
          }

          function init_right_box(){
            $(".rightPlayer").css("opacity", "0.5");
            $(".rightPlayer").attr("id", 0);
            $("._rightName").text("Player");
            $("._rightScore").text("Score");
            $("._rightAverage").text("Average");
          }

          function init_char_box(){
            $("._char_box").css({"background-color":"white", "opacity":0.5});
          }
          $("._char_box").on("click", function(){
                if($(this).css("opacity")==0.9){
                    $(this).css("opacity", "0.5");
                    $(this).css("background-color", "white");

                    selectChar--;

                    if($(".leftPlayer").attr("id")==this.id){
                        if($(".rightPlayer").attr("id")==0){
                            // Left Delete
                            init_left_box();

                        }else{
                            // Left=Right
                            $(".leftPlayer").attr("id", $(".rightPlayer").attr("id"));
                            $("._leftName").text($("._rightName").eq(0).text());
                            $("._leftScore").text($("._rightScore").text());
                            $("._leftAverage").text($("._rightAverage").text());

                            init_right_box();

                            lid=$(".leftPlayer").attr("id");
                            $("div[id="+lid+"]").css("background-color", $(".leftPlayer").css("background-color"));
                        }
                    }else{
                        // Right Delete

                        init_right_box();
                    }

                }else if(selectChar>1){
                        //alert("Too Many");
                }else{
                    $(this).css("opacity", "0.9");

                     if($(".leftPlayer").attr("id")=='0'){
                        $.ajax({
                            data: { id:this.id},
                            url: "/main/getinfo",
                            dataType:"json",
                            success: function(res){
                                // alert(res["wc"]);
                                $(".leftPlayer").attr("id", res["inf"][0]["id"]);
                                $(".leftPlayer").css("opacity", "0.9");
                                $("._leftName").text(res["inf"][0]["name"]);
                                $("._leftScore").text(res["wc"]+res["lc"]+"전 "+res["wc"]+"승 "+res["lc"]+"패");
                                $("._leftAverage").text(res["inf"][0]["average"]);
                             }
                        });

                        $(this).css("background-color",$(".leftPlayer").css("background-color"));

                    }else{
                        $.ajax({
                            data: { id:this.id},
                            url: "/main/getinfo",
                            dataType:"json",
                            success: function(res){
                                //alert(res[0]["name"]);
                                $(".rightPlayer").attr("id", res["inf"][0]["id"]);
                                $(".rightPlayer").css("opacity", "0.9");
                                $("._rightName").text(res["inf"][0]["name"]);
                                $("._rightScore").text(res["wc"]+res["lc"]+"전 "+res["wc"]+"승 "+res["lc"]+"패");
                                $("._rightAverage").text(res["inf"][0]["average"]);
                             }
                        });

                        $(this).css("background-color",$(".rightPlayer").css("background-color"));

                    }

                    selectChar++;
                }

                if(selectChar==2){
                    $("._turn").css("opacity","0.9");
                    $("._turn").text("게임 시작");
                }else if(selectChar==0){
                    $("._turn").css("opacity","0.9");
                    $("._turn").text("연습 게임 시작");
                }else if(selectChar==1){
                    $("._turn").css("opacity","0.3");
                    $("._turn").text("혼자서는 게임을 할 수 없습니다");
                }
          });

        function playerChange(){
            if(selectChar<2) return;

            tempid=$(".rightPlayer").attr("id");
            tempname=$("._rightName").eq(0).text();
            tempscore=$("._rightScore").text();
            tempavg=$("._rightAverage").text();
            tempcolor=$("._char_box").filter("#"+tempid).css("background-color");

            $(".rightPlayer").attr("id", $(".leftPlayer").attr("id"));
            $("._rightName").text($("._leftName").eq(0).text());
            $("._rightScore").text($("._leftScore").text());
            $("._rightAverage").text($("._leftAverage").text());
            $("._char_box").filter("#"+tempid).css("background-color", $("._char_box").filter("#"+$(".leftPlayer").attr("id")).css("background-color"));

            $(".leftPlayer").attr("id", tempid);
            $("._leftName").text(tempname);
            $("._leftScore").text(tempscore);
            $("._leftAverage").text(tempavg);
            $("._char_box").filter("#"+$(".rightPlayer").attr("id")).css("background-color", tempcolor);

        }

        $(".rightPlayer, .leftPlayer").on("click", function(){
           playerChange();
        });

    </script>

</html>